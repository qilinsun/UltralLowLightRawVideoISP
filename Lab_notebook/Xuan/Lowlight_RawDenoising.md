
## å·¥ä½œè¿›ç¨‹ï¼š

### 2023.2.4

+ å°è¯•äº†Meshflowçš„æ–¹æ³•ï¼Œæµ‹è¯•äº†å‡ ä¸ªrgbè§†é¢‘ï¼Œæ•ˆæœä¸é”™ï¼Œè¿™ä¸ªä»£ç å¯ç”¨ã€‚
+ Meshflowåˆ†ä¸ºä¸¤æ­¥ï¼ŒæŠŠè¿™ä¸¤æ­¥çš„ç»“æœéƒ½åšäº†ä¸€æ¬¡è¾“å‡ºã€‚ç„¶åå°†rawå›¾åƒåº”ç”¨åˆ°è¿™ä¸ªä»£ç ä¸­ï¼Œç¬¬ä¸€æ­¥ä¸­æœ‰äº›å›¾åƒå¸§å¯ä»¥ï¼Œæœ‰äº›ä¸è¡Œï¼Œä½†æ˜¯èƒ½å¤Ÿæœ‰æ˜¾ç¤ºæ­£ç¡®çš„å›¾åƒé€šè¿‡ç¬¬äºŒæ­¥å¹³æ»‘ååä¸èƒ½å®ç°äº†ã€‚
    + ç¬¬ä¸€æ­¥çš„ç»“æœ
|      frame6      |   frame7  |   frame8   | frame9 |
| :--: | --------- | --------- | ----------- |
|![](../../Docs/Images/Meshflow_result/stabilized_frame_6.png)|![](../../Docs/Images/Meshflow_result/stabilized_frame_7.png)|![](../../Docs/Images/Meshflow_result/stabilized_frame_8.png)|(![](../../Docs/Images/Meshflow_result/stabilized_frame_9.png)|
+ ç»§ç»­è°ƒç ”äº†å‡ ä¸ªæ–¹æ³•ï¼ŒPatchMatch: A Randomized Correspondence Algorithm for Structural Image Editingï¼ŒThe Generalized PatchMatch Correspondence Algorithmï¼ŒCollaborative Filtering of Correlated Noise: Exact Transform-Domain Variance for Improved Shrinkage and Patch Matchingï¼Œç›®å‰åœ¨ç†è¿™äº›æ–¹æ³•çš„ä»£ç 


### 2023.1.3

+ pipeline

![](../..//Docs/Images/Pipeline0103.png)

+ ç®—æ³•æµç¨‹

é¦–å…ˆRawè§†é¢‘åºåˆ—è¢«è¾“å…¥ï¼Œç„¶åé€šè¿‡FIFO Bucketä¿æŒä¸€å®šæ•°é‡çš„å›¾åƒå¸§ï¼Œå½“ä¸€å¸§å¤„ç†å®Œï¼Œä¸‹ä¸€å¸§ä½œä¸ºå½“å‰å¸§æ—¶ï¼Œ
åˆä¼šä»è§†é¢‘åºåˆ—ä¸­è¡¥å……ä¸€å¸§ç»´æŒä½¿ç”¨æ•°é‡ï¼Œä»è€Œå½¢æˆä¸€ä¸ªåŠ¨æ€çš„è¿‡ç¨‹ã€‚æ¥ç€é€šè¿‡è¿åŠ¨ä¼°è®¡æ¥é€‰æ‹©èåˆçš„å›¾åƒå¸§ï¼Œè¿åŠ¨
ä¼°è®¡éƒ¨åˆ†ä½¿ç”¨handheldä¸­çš„æµä¼°è®¡æ–¹æ³•ï¼Œé€šè¿‡å¼ºåº¦å’Œæ¢¯åº¦è¿›è¡Œä¼°è®¡ï¼Œå†é€šè¿‡ä¸­å¿ƒåŠ æƒå’ŒGMMæ¥é¢„æµ‹å‡ºæœ€å°çš„è¿åŠ¨ï¼Œ
ä»¥æ­¤ç”¨æœ€å°è¿åŠ¨å’Œå¯æ¥å—çš„æ¨¡ç³Šåƒç´ å€¼è®¡ç®—å‡ºèåˆçš„å¸§æ•°ã€‚éšååˆ©ç”¨å¸§é—´ä¿¡æ¯ä½¿ç”¨ä¸‰ç»´çš„å»æ¨¡ç³Šæ–¹æ³•å»æ¨¡ç³Šã€‚æœ€åé€š
è¿‡å¯¹é½åˆå¹¶çš„æ–¹æ³•å»å™ªï¼Œç»è¿‡ISPå½¢æˆå»å™ªåçš„è§†é¢‘åºåˆ—

+ å®éªŒç»“æœï¼šå°†èåˆå¸§æ•°å˜æˆåŠ¨æ€åï¼Œæœ‰æ”¹å–„æ•ˆæœï¼Œä½†åœ¨æŸäº›ä½ç½®è¿˜å­˜åœ¨åŒ¹é…é”™è¯¯ã€‚å› æ­¤ï¼Œé€šè¿‡å¯¹é½æ–¹å¼æ‰¾ç›¸ä¼¼å—è¿›è¡ŒåŒ¹é…å¯èƒ½ä¸å‡†ï¼Œéœ€è¦æ”¹è¿›ã€‚

### 12.11-17

+ é‡æ–°æ‹æ‘„äº†ç°é˜¶å¡çš„å›¾ç‰‡ï¼Œä¾ç„¶åˆ†åˆ«åœ¨ä½ç…§åº¦å’Œé«˜ç…§åº¦ä¸‹è¿›è¡Œäº†å™ªå£°ä¼°è®¡ï¼Œå¾—åˆ°RMSå™ªå£°ï¼Œæ­¤å€¼ä¸ºæ ‡å‡†å·®ï¼Œå³å¯æ¨å‡ºæ–¹å·®ã€‚

    + ä¹‹å‰çš„å…¬å¼å»ºæ¨¡å‡ºçš„å™ªå£°è¿›è¡Œè®­ç»ƒï¼Œæµ‹è¯•å›¾ç‰‡ç»“æœæ˜¯é»‘è‰²çš„ã€‚shot noiseç¬¦åˆæ³Šæ¾ï¼Œå®ƒçš„å‚æ•°é€šè¿‡ä½ç…§åº¦å›¾åƒä¼°è®¡å‡ºæ¥ï¼ŒfpnåŒæ ·ä¹Ÿç¬¦åˆæ³Šæ¾åˆ†å¸ƒï¼Œå®ƒçš„å‚æ•°æ˜¯é€šè¿‡è®¡ç®—åŒä¸€æ›å…‰æ—¶é—´ä¸‹çš„30å¼ å›¾ç‰‡çš„å‡å€¼åœ¨è®¡ç®—æ ‡å‡†å·®å¾—å‡ºï¼Œread noiseç¬¦åˆé«˜æ–¯åˆ†å¸ƒï¼Œå®ƒçš„å‚æ•°é€šè¿‡é«˜ç…§åº¦å›¾åƒä¼°è®¡å‡ºæ¥çš„ã€‚ç°åœ¨æ”¹äº†å™ªå£°å»ºæ¨¡çš„ç”Ÿæˆä»£ç å’Œå…¬å¼ï¼Œå¯¹æ¨¡å‹é‡æ–°è®­ç»ƒã€‚
    
+  æ‹æ‘„äº†ä¸€äº›è¿ç»­çš„å¸¦æœ‰åŠ¨ä½œçš„å›¾ç‰‡ï¼Œæ¥è¿›è¡Œæµ‹è¯•
    
    + é—®é¢˜ï¼šä¼šå­˜åœ¨åˆå¹¶é”™è¯¯çš„åœ°æ–¹ã€‚**å¢åŠ äº†å¯¹é½å’Œåˆå¹¶é˜¶æ®µçš„å›¾åƒæ•°é‡ï¼Œå¯ä»¥è§£å†³ä¸€äº›åˆå¹¶ä¸­çš„é—®é¢˜**

+ æ ¡æ­£ç™½å¹³è¡¡

å®éªŒç»“æœåŠå…¶ä»–æ–¹æ³•çš„å¯¹æ¯”ç»“æœè§[æ–‡ä»¶](https://github.com/qilinsun/UltralLowLightRawVideoISP/tree/main/Docs/Images/12.17ç»“æœ)

------

### 12.6-10

+ vevidæ–¹æ³•çš„å¤ç°

+ è°ƒæ•´é¢„å»å™ªç½‘ç»œ

+ æ ¹æ®handheldæ–¹æ³•è°ƒæ•´éƒ¨åˆ†pipeline

#### å®éªŒç»“æœ

+ pipelineä¹‹é—´çš„å¯¹æ¯”ç»“æœ

|      HDR+      |   Denoising+HDR+  |   Deblur+HDR+   | Denoising+Deblur+HDR+ |
| :--: | --------- | --------- | ----------- |
|![](../../Docs/Images/1128å¯¹æ¯”ç»“æœ/hdr+/å‡å»é»‘ç”µå¹³_hdr+/srgb_part.png)|![](../../Docs/Images/1210results/denoising+hdr/srgb_part.png)|![](../../Docs/Images/1128å¯¹æ¯”ç»“æœ/estrnn_deblur_hdr+/å‡å»é»‘ç”µå¹³_pipelinev2/srgb_part.png)|![](../../Docs/Images/1210results/denoising+deblur+hdr/srgb_part.png)|

+ åŠ å…¥vivedçš„ç»“æœ

|      Vevid+HDR+      |   Denoising+Vevid+HDR+  |   Vevid+Deblur+HDR+   | Denoising+Vevid+Deblur+HDR+ |
| :--: | --------- | --------- | ----------- |
|![](../../Docs/Images/1210results/hdr+vevid_simple_g0.6_b_0.5/srgb_part.png)|![](../../Docs/Images/1210results/denoising+vevid+hdr/srgb_part.png)|![](../../Docs/Images/1210results/vevid+pipelinev2/srgb_part.png)|![](../../Docs/Images/1210results/denoising+vevid+deblur+hdr/srgb_part.png)|

+ å¯¹æ¯”è¯•éªŒ

| HDR+ | Maskdngan | Starlight | Denoise+vevid+Deblur+HDR+ |
| :--: | --------- | --------- | ----------- |
|![](../../Docs/Images/1128å¯¹æ¯”ç»“æœ/hdr+/å‡å»é»‘ç”µå¹³_hdr+/srgb_part.png)|![](../../Docs/Images/1128å¯¹æ¯”ç»“æœ/maskdngan_result/rawpyåå¤„ç†ç»“æœ/å‡å»é»‘ç”µå¹³/frame3_denoised_sRGB.png)|![](../../Docs/Images/1128å¯¹æ¯”ç»“æœ/hrnet_starlight/1129starlightåŸæœ¬ç»“æœ/å‡å»é»‘ç”µå¹³/denoise_raw.png)|![](../../Docs/Images/1210results/denoising+vevid+deblur+hdr/srgb_part.png)|

### 11.28-12.2

+ è¡¥å……äº†å¯¹æ¯”å®éªŒï¼Œç®—æ³•åˆ†åˆ«ä¸ºhdr+ï¼Œmaskdnganï¼Œstarlightï¼Œç»“æœå¦‚ä¸‹

**è¿™é‡Œçš„æˆ‘ä»¬çš„ç®—æ³•ï¼Œåªå¢åŠ äº†ESTRNNç½‘ç»œåšdeblurï¼Œé¢„å»å™ªçš„éƒ¨åˆ†è¿˜æœªåŠ å…¥ï¼Œç­‰è‡ªå·±çš„å™ªå£°æ¨¡å‹æ•°æ®è®­ç»ƒå¥½ä¹‹åå†åŠ å…¥ï¼Œå¹¶ä¸”ä»¥ä¸‹å‡å»äº†é»‘ç”µå¹³**

| HDR+ | Maskdngan | Starlight | Deblur+HDR+ |
| :--: | --------- | --------- | ----------- |
|![](../../Docs/Images/1128å¯¹æ¯”ç»“æœ/hdr+/å‡å»é»‘ç”µå¹³_hdr+/srgb_part.png)|![](../../Docs/Images/1128å¯¹æ¯”ç»“æœ/maskdngan_result/rawpyåå¤„ç†ç»“æœ/å‡å»é»‘ç”µå¹³/frame3_denoised_sRGB.png)|![](../../Docs/Images/1128å¯¹æ¯”ç»“æœ/hrnet_starlight/1129starlightåŸæœ¬ç»“æœ/å‡å»é»‘ç”µå¹³/denoise_raw.png)|![](../../Docs/Images/1128å¯¹æ¯”ç»“æœ/estrnn_deblur_hdr+/å‡å»é»‘ç”µå¹³_pipelinev2/srgb_part.png)|

+ åœ¨ISO 2500, F2.8, æ›å…‰æ—¶é—´1/30çš„æ¡ä»¶ä¸‹ï¼Œæ‹æ‘„äº†ä¸¤ç»„ç°é˜¶å¡ç…§ç‰‡ï¼Œä¸€ç»„æ˜¯ä½å…‰ç…§ï¼Œä¸€ç»„æ˜¯é«˜å…‰ç…§ã€‚å› ä¸ºimatestè½¯ä»¶çš„æ–‡æ¡£è¯´ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ç¬¦åˆé«˜æ–¯åˆ†å¸ƒï¼Œä½†æ˜¯åœ¨ä½å…‰æƒ…å†µä¸‹æ˜¯æ›´ç¬¦åˆæ³Šæ¾åˆ†å¸ƒï¼Œå› 
æ­¤æ‹æ‘„ä¸¤ç»„ç…§ç‰‡ï¼Œé€šè¿‡åˆ†æå¾—åˆ°é«˜æ–¯å’Œæ³Šæ¾åˆ†å¸ƒçš„å‚æ•°ï¼Œåˆ†æè¿‡ç¨‹å’Œç»“æœè§[æ–‡ä»¶](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/Docs/Images/1128%E5%99%AA%E5%A3%B0%E5%BB%BA%E6%A8%A1%E7%BB%93%E6%9E%9C/noise.pdf)ï¼Œä½å…‰ç…§ä¸‹çš„ä¼°è®¡å™ªå£°ä¸º0.0204ï¼Œé«˜ç…§åº¦ä¸‹çš„ä¼°è®¡å™ªå£°ä¸º0.02295

+ ç ”ç©¶Fixed pattern noiseçš„åˆ†æ

    + imatestè½¯ä»¶æ²¡å…·ä½“ä»‹ç»fpnçš„ä¼°è®¡ï¼Œå‚è€ƒäº†ç½‘ä¸Šçš„ä»£ç å¯¹fpnè¿›è¡Œä¼°è®¡ï¼Œ[code](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/noise_model/Dark_fpn.py)ï¼Œä¼°è®¡çš„å™ªå£°ä¸º9.936909

+ æ ¹æ®ä¸Šé¢åˆ†æå‡ºçš„å™ªå£°ï¼Œæ ¹æ®å™ªå£°æ¨¡å‹ğ’™_ğ’‘~ ğˆ_ğ’”^ğŸ ğ“Ÿ(ğ’š_ğ’‘/ğˆ_ğ’”^ğŸ) + ğ“Ÿ(ğ‘µ_ğ‘­ğ‘·ğ‘µ) + ğ“(ğŸ,ğˆ_ğ’“^ğŸ)ï¼Œ[code](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/noise_model/generate_noise.py)ï¼Œå¾—å‡ºå™ªå£°å›¾æ”¾å…¥åˆ°ç¥ç»ç½‘ç»œä¸­è¿›è¡Œè®­ç»ƒï¼Œç»“æœæ²¡é‚£ä¹ˆçš„å¥½ï¼Œæœ‰éƒ¨åˆ†æœªæ¢å¤å‡ºæ¥ï¼Œä¸”åœ¨æ•´ä¸ªpipelineä»£ç è¿è¡Œæ—¶ï¼Œéƒ¨åˆ†patché‡Œä¼šæœ‰0ï¼Œå› æ­¤ä¼šåœ¨ç©ºé—´å»å™ªæ—¶æœ‰é—®é¢˜ï¼Œä¼šå‡ºç°é™¤ä»¥0çš„æƒ…å†µï¼Œåœ¨è¿™åŠ äº†ä¸ª1e-6ï¼Œç›®å‰ç»“æœå¦‚ä¸‹![](../../Docs/Images/1210results/denoising+deblur+hdr/srgb_part.png)

+ Raw videoçš„å¤„ç†ï¼Œffmpegæ–¹æ³•æŠ½å¸§ä¸èƒ½è¾“å‡ºæˆrawæ ¼å¼ï¼Œåªèƒ½è¾“å‡ºrgbæ ¼å¼

#### åç»­å·¥ä½œ

+ å¯èƒ½éœ€è¦è°ƒæ•´ä¸€ä¸‹ç›®å‰çš„å™ªå£°æ¨¡å‹

+ å°†å¤ç°çš„vevidæ–¹æ³•æ”¾è¿›pipelineä¸­æå‡ä¸€ä¸‹ä¿¡æ¯ï¼Œç›®å‰åœ¨è°ƒæ•´è¯¥æ–¹æ³•çš„ä»£ç 

+ rawè§†é¢‘çš„å¤„ç†

### 2022.11.26ç»„ä¼š

+ è·Ÿç°æœ‰çš„sotaç®—æ³•åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šåšå¯¹æ¯”

+ å™ªå£°æ¨¡å‹éœ€è¦å®Œå–„ï¼Œé‡æ–°æ‹å›¾ä¸åšå»é©¬èµ›å…‹å¤„ç†

+ å¯¹denoiseçš„å›¾é‡æ–°æ£€æŸ¥

+ éœ€è¦åšç™½å¹³è¡¡

### 2022.11.21-25

+ è°ƒæ•´äº†deblurå’Œside window filteringçš„ä½ç½®â€”â€”pipeline v5ï¼Œç»“æœå¦‚ä¸‹

![](../../Docs/Images/221120ç»“æœ/deblur_side_pipeline/3.png)

+ ä¸ä¹‹å‰çš„pipeline v4ç»“æœå¯¹æ¯”

| Method | Pipeline v4 | Pipeline v5 |
| :----: | :---------: | :---------: |
| Result       | ![](../../Docs/Images/221120ç»“æœ/Pipeline_side_deblur(15)/3.png)           |![](../../Docs/Images/221120ç»“æœ/deblur_side_pipeline/3.png)             |

+ æŒ‰ç…§sonyçš„é˜µåˆ—è¿›è¡Œè°ƒæ•´ï¼Œé˜µåˆ—å¦‚ä¸‹ï¼š

![](../../Docs/Images/sony-quad-bayer.jpg)

**æˆªå–äº†éƒ¨åˆ†å›¾åƒè¿›è¡Œæµ‹è¯•ï¼Œä¸”ç¬¬ä¸€è¡Œå’Œç¬¬ä¸€åˆ—æˆªå–æ‰ï¼Œæˆªå–çš„shape[1:1425, 1:2129],ç»“æœè¿˜æ˜¯å‘ˆç²‰è‰²ï¼Œè¿™ä¸ªç»“æœçš„é¢œè‰²æ˜¯ä¸æ˜¯å’Œå‚æ•°çš„è®¾ç½®ç›¸å…³ï¼Œä½¿ç”¨rawpyè¯»å–çš„rawå›¾åƒï¼Œpatternæ˜¾ç¤ºæ˜¯RGBG**

+ å°†ä¹‹å‰çš„å»å™ªç½‘ç»œï¼Œæ¢äº†æ•°æ®é›†ä¹‹åè¿›è¡Œé‡æ–°è®­ç»ƒï¼Œç°åœ¨çš„æ•°æ®æ˜¯SIDçš„GTå’ŒGT+fixed pattern noiseï¼Œç„¶ååœ¨starlightæ•°æ®é›†ä¸Šåœ¨æµ‹è¯•

#### è‡ªå·±æ‹æ‘„çš„æ•°æ®é›†è°ƒè¯•çš„ç»“æœ

+ ä¹‹å‰é¢œè‰²çš„é—®é¢˜åº”è¯¥æ˜¯åœ¨raw2rgbæ—¶ä¸€äº›è¿‡ç¨‹å‚æ•°çš„è®¾ç½®ä¸å¯¹ï¼Œç„¶åæ›´æ¢äº†æ¯”è¾ƒç®€å•çš„å¤„ç†æ–¹å¼è¿›è¡Œå°è¯•,æ›´æ¢æ–¹æ³•å¦‚ä¸‹

```python
# raw2rgb
self.rawpyParam1 = {
    'demosaic_algorithm': rawpy.DemosaicAlgorithm.AHD,  # used in HDR+ supplement
    'half_size': False,
    'use_camera_wb': True,
    'use_auto_wb': False,
    'no_auto_bright': True,
    'output_color': rawpy.ColorSpace.sRGB,
    'output_bps': 16}
# hdr+ postprocess
pre_raw = self.load_video_raw('/media/cuhksz-aci-03/æ•°æ®/CUHK_SZ/',seqID='8')
pre_raw.raw_image_visible[0:1420, 0:2120] = mergedImage[:]
post_image = pre_raw.postprocess(**self.rawpyParam1)

# To HSV and local tone mapping
cfa = (post_image / 65535. * 255.).astype(np.float32)# scale and set type for cv2
hsv = cv2.cvtColor(cfa, cv2.COLOR_RGB2HSV) 
hsvOperator = AutoGammaCorrection(hsv)
enhanceV = hsvOperator.execute()
hsv[...,-1] = enhanceV*255.
enhanceRGB = cv2.cvtColor(hsv, cv2.COLOR_HSV2RGB)
```
+ ç»“æœå¦‚ä¸‹ï¼Œä½†æ˜¯è½¬æ¢å‡ºçš„rgbå›¾åƒåç»¿è‰²ï¼Œlocal tone mappingçš„ç»“æœä¹Ÿæ˜¯åç»¿è‰²

**ç”¨çš„deblurç½‘ç»œæ˜¯9ä¸ªblockï¼Œå‚æ•°1.82M**

**æ‰€æœ‰ç»“æœè§[æ–‡ä»¶](https://github.com/qilinsun/UltralLowLightRawVideoISP/tree/main/Docs/Images/1124%E7%BB%93%E6%9E%9Csrgb)**

| Method |Original|Pipeline v1|Pipeline v2|Pipeline v3|Pipeline v4|
| :----: | -------------------------------------------------------- | :------------------------------------------------------: | :------------------------------------------------------: | :------------------------------------------------------: | :------------------------------------------------------: |
| Result | ![](../../Docs/Images/1124ç»“æœsrgb/seq8_ori/srgb.png) | ![](../../Docs/Images/1124ç»“æœsrgb/seq8/srgb_part.png) | ![](../../Docs/Images/1124ç»“æœsrgb/seq8/pipeline2param1/srgb_part.png) | ![](../../Docs/Images/1124ç»“æœsrgb/seq8/hdr+denoise/srgb_part.png) | ![](../../Docs/Images/1124ç»“æœsrgb/seq8/pipelinev4param/srgb_part.png) |

+ å»ºç«‹å™ªå£°æ¨¡å‹ï¼šğ’™_ğ’‘~ ğˆ_ğ’”^ğŸ ğ“Ÿ(ğ’š_ğ’‘/ğˆ_ğ’”^ğŸ) + ğ“Ÿ(ğ‘µ_ğ‘­ğ‘·ğ‘µ) + ğ“(ğŸ,ğˆ_ğ’“^ğŸ)

#### é—®é¢˜

+ ä½¿ç”¨é¢„å»å™ªçš„æ–¹æ³•ä¼šæ”¹å˜é¢œè‰²ï¼Œå‡ºç°é¢œè‰²ä¸Šçš„åå·®

+ ç›®å‰çš„å™ªå£°æ¨¡å‹å»ºç«‹çš„æ˜¯å¦æ­£ç¡®

+ åœ¨ä½isoæ‹æ‘„çš„æ•°æ®ä¸­ï¼Œæ•ˆæœä¸å¥½ï¼Œä¸”é¢„å»å™ªå’Œdeburéƒ½ä¼šå¯¹å›¾åƒçš„é¢œè‰²æœ‰æ˜æ˜¾å½±å“

------

### 2022.11.19ç»„ä¼š

#### ç›®å‰çš„pipelineé—®é¢˜ï¼šç»†èŠ‚ä¿¡æ¯éƒ¨åˆ†æå‡äº†ï¼Œä½†èƒŒæ™¯ä¿¡æ¯ä¸¢å¤±äº†

#### é¢„å¤„ç†ä½¿ç”¨çš„é™å™ªç½‘ç»œ

+ ä½¿ç”¨unetç½‘ç»œè¿›è¡Œé¢„å¤„ç†é™å™ªï¼Œæ•ˆæœä¸€èˆ¬ï¼Œå¯ä»¥ä½¿ç”¨19å¹´cvprçš„side window filteringæ–¹æ³•è¿›è¡Œå®éªŒ

#### Starlightæ•°æ®é›†ç»“æœ

+ ç”±ç›®å‰å¢åŠ äº†denoisingç½‘ç»œçš„ç»“æœçœ‹ï¼Œé¢œè‰²å˜å¾—è¿‡å¤šï¼Œé¢œè‰²ä¸æ­£ç¡®ï¼Œæ£€æŸ¥æ˜¯å¦å¼„åäº†é€šé“ï¼Œä¸”èƒŒæ™¯ä¿¡æ¯ä¸¢å¤±ä¸¥é‡ï¼ŒèƒŒæ™¯ä¸­çš„æ˜Ÿæ˜Ÿæ²¡æœ‰æ¢å¤å‡ºæ¥

   + **è§£å†³æ–¹æ³•**ï¼šé’ˆå¯¹é¢œè‰²é—®é¢˜ï¼Œåœ¨Rawå›¾åƒæ”¾å…¥åˆ°ç½‘ç»œå‰ï¼Œåšå‡è¡¡åŒ–ï¼›èƒŒæ™¯ä¿¡æ¯ä¸¢å¤±ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨é»‘ç”µå¹³çš„ä¿¡æ¯

#### è‡ªå·±æ‹æ‘„çš„æ•°æ®ç»“æœ

+ åœ¨pipelineçš„æµ‹è¯•å½“ä¸­ï¼Œæ•´ä½“å›¾åƒé¢œè‰²å‘ˆç°ç²‰è‰²

   + **è§£å†³æ–¹æ³•**ï¼šç´¢å°¼A7ç›¸æœºçš„bayeræ’å¸ƒå¯èƒ½ä¸æ˜¯ä¸€æ ·çš„ï¼Œéœ€è¦è¿›è¡Œè°ƒæ•´

------

### 2022.11.13-11.20

+ ä½¿ç”¨DRVæ•°æ®é›†å’Œè‡ªå·±æ‹æ‘„çš„æ•°æ®é›†éªŒè¯äº†ä¸€ä¸‹ç›®å‰çš„æ¡†æ¶

   + **é—®é¢˜**ï¼šé¢œè‰²é”™è¯¯ï¼Œæ•´ä½“æ˜¾ç¤ºç²‰è‰²ï¼›DRVå’Œè‡ªå·±æ‹æ‘„çš„æ•°æ®åº”è¯¥éƒ½æ˜¯é™æ­¢çš„å›¾ç‰‡ï¼Œæ²¡æœ‰æ¨¡ç³Šæƒ…å†µå­˜åœ¨ï¼Œå®éªŒå‡ºçš„æ•ˆæœä¸å¥½

   + **Raw videoçš„é‡‡é›†**: éœ€è¦ä¸€ä¸ªå¤–å½•å±é‡‡é›†Raw videoï¼Œç›´æ¥æ‹æ‘„å‡ºçš„è§†é¢‘æ˜¯mp4æ ¼å¼

+ åœ¨D65å…‰æºçš„æ¡ä»¶ä¸‹ï¼Œé‡æ–°æ‹æ‘„äº†ç°é˜¶å›¾ï¼Œå¹¶æ ¹æ®ç›®å‰çš„ä¸€äº›æ–‡çŒ®ï¼Œå­¦ä¹ å™ªå£°æ ‡å®š

   + æ³Šæ¾åˆ†å¸ƒçš„å™ªå£°: fixed pattern noise + shot noise

   + é«˜æ–¯åˆ†å¸ƒçš„å™ªå£°: Read noise

+ è®­ç»ƒè°ƒè¯•æ·±åº¦é™å™ªç½‘ç»œä½œä¸ºä¸€ä¸ªé¢„å¤„ç†

   + ä½¿ç”¨çš„æ•°æ®é›†ï¼šSIDçŸ­æ›å…‰å›¾åƒ + Statlightçš„fixed pattern noiseå’Œä½œä¸ºgtçš„SIDé•¿æ›å…‰å›¾åƒï¼Œå…¶ä¸­fixed pattern noiseè£å‡æˆ512 * 512å¤§å°çš„

   + **ç›®å‰çš„é—®é¢˜**ï¼šç”±ä»¥ä¸Šæ•°æ®è®­ç»ƒå‡ºçš„unetç½‘ç»œæ•ˆæœä¸€èˆ¬ï¼Œåé¢å¯¹æ­¤ç½‘ç»œçš„è®­ç»ƒä½¿ç”¨çš„æ•°æ®æ˜¯å¦åªç”¨åœ¨gtå›¾åƒä¸ŠåŠ å…¥fixed pattern noiseï¼Œä»è€Œè¾¾åˆ°å»é™¤ç›®å‰starlightæ•°æ®é›†ä¸­fixed 
                   pattern noiseçš„ç›®çš„

   + ç»Ÿè®¡äº†Deblurç½‘ç»œä½¿ç”¨ä¸åŒblockçš„å‚æ•°é‡ï¼Œå¹¶è®­ç»ƒäº†blockä¸º9çš„ç½‘ç»œï¼ŒåŒæ—¶æ”¾å…¥åˆ°äº†pipelienä¸­è¿›è¡Œå®éªŒ
   
 + side window filteringæ–¹æ³•çš„å®éªŒ

### 2022.11.13-11.20 ä»£ç å’Œå¯¹åº”æµ‹è¯•ç»“æœ

#### ä»£ç å·²ç»ä¸Šä¼ åˆ°githubä¸­

+ é¢„å¤„ç†çš„é™å™ªç½‘ç»œå’Œè®­ç»ƒä»£ç ï¼Œ[Code](https://github.com/qilinsun/UltralLowLightRawVideoISP/tree/main/deep_denoising)

+ å»æ¨¡ç³Šä»£ç ï¼Œ[ESTRNN](https://github.com/qilinsun/UltralLowLightRawVideoISP/tree/main/model)å’Œ[å‚æ•°æ–‡ä»¶](https://github.com/qilinsun/UltralLowLightRawVideoISP/tree/main/para)

+ Side window filtering [python code](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/Utility/SideWindowFilter.py)
   
#### å®éªŒç»“æœï¼Œæ‰€æœ‰ç»“æœåœ¨[github](https://github.com/qilinsun/UltralLowLightRawVideoISP/tree/main/Docs/Images/221120ç»“æœ)
#### ä»¥ä¸‹å®éªŒç»“æœä½¿ç”¨çš„deblurç½‘ç»œå‡æ˜¯15ä¸ªblockçš„ï¼Œå‚æ•°é‡ä¸º2.82M

+ Starlightæ•°æ®é›†ï¼šStarlight, Pipeline v1(hdr+), Pipleine v2(deblur+hdr+), Pipeline v3(deep denoiser+deblur+hdr+), Pipeline v4(side+deblur+hdr+)

| Method | Starlight                                                |                       Pipeline v1                        |                       Pipeline v2                        |                       Pipeline v3                        |                       Pipeline v4                        |
| :----: | -------------------------------------------------------- | :------------------------------------------------------: | :------------------------------------------------------: | :------------------------------------------------------: | :------------------------------------------------------: |
| Result | ![](../../Docs/Images/221120ç»“æœ/starlight/3.png) | ![](../../Docs/Images/221120ç»“æœ/pipeline_crop/3.png) | ![](../../Docs/Images/221120ç»“æœ/pipeline_deblur(15)/3.png) | ![](../../Docs/Images/221120ç»“æœ/pipeline_deblur(15)_denoise(900)/3.png) | ![](../../Docs/Images/221120ç»“æœ/Pipeline_side_deblur(15)/3.png) |

+ è‡ªå·±æ‹æ‘„çš„æ•°æ®é›†ç»“æœ

| Method | Pipeline v1 | Pipeline v3 |
| :----: | :---------: | :---------: |
| Result       | ![](../../Docs/Images/221120ç»“æœ/pipeline_shoot/0.png)            |![](../../Docs/Images/221120ç»“æœ/pipelin_deblur_denoise_shoot/0.png)             |

------

### 2022.11.12ç»„ä¼š

+ Pipelineå®ç°çš„ç›®æ ‡ï¼šæœ€å°çš„è®¡ç®—é‡å®ç°è¾ƒå¥½çš„æ•ˆæœ

+ å»æ¨¡ç³Šç½‘ç»œå’Œæ·±åº¦é™å™ªç½‘ç»œçš„ä¼˜åŒ–ï¼Œå°½é‡ä½¿ç½‘ç»œçš„å‚æ•°å°‘ï¼Œæ¨¡å‹å°

+ æ‹æ‘„ç°é˜¶å›¾åšå™ªå£°æ ‡å®š

   + å°†ç›¸æœºå’Œå…‰æºéƒ½è°ƒæˆD65

   + æ‹æ‘„ç°é˜¶å¡ï¼Œä½¿ç”¨imatestç”Ÿæˆå™ªå£°æ¨¡å‹ï¼Œç„¶åæ ¹æ®æ­¤å™ªå£°æ¨¡å‹ï¼Œå°†å…¶å»ºæ¨¡å‡ºæ¥ï¼ˆé«˜æ–¯å™ªå£°å’Œæ³Šæ¾å™ªå£°ï¼Œä¸”æ³Šæ¾å™ªå£°åŒ…æ‹¬fixed pattern noiseï¼‰

+ æµ‹è¯•è‡ªå·±æ‹æ‘„çš„å›¾åƒ

------

### 2022.11.6-11.12

+ æ­å»ºç®€å•çš„unetç½‘ç»œï¼Œé€‰æ‹©å¹¶ä¸‹è½½åˆé€‚çš„æ•°æ®é›†(SIDå’ŒDRV)

+ æ‹æ‘„äº†ä¸åŒè‰²æ¸©ä¸‹çš„ç°é˜¶å›¾åƒï¼Œåœ¨imatesté‡Œè¿›è¡Œå™ªå£°åˆ†æ

   + å¯¹imatestè¯¥è½¯ä»¶é‡Œçš„éƒ¨åˆ†å‚æ•°è¦å­¦ä¹ è°ƒè¯•ï¼Œç›®å‰äº†è§£åº¦ä¸å¤Ÿ

+ æ‹æ‘„äº†ä¸åŒisoï¼Œfå‚æ•°ä¸‹çš„ä½å…‰æ•°æ®é›†

------

### 2022.11.5ç»„ä¼š

+ ç›®å‰å¤„ç†çš„å›¾åƒä¸­å­˜åœ¨fixed pattern noise

   + å¯ä»¥ä½¿ç”¨ä¸‰äº”å±‚ç®€å•çš„ç¥ç»ç½‘ç»œå°†å…¶å»é™¤

+ æ‹æ‘„ä½å…‰å›¾åƒ

+ åšå™ªå£°æ ‡å®š

------

### 2022.10.31-11.6

+ å¯¹ä¸Šä¸€å‘¨å·¥ä½œä¸­å‡ºç°çš„ç»†èŠ‚é”™è¯¯è¿›è¡Œäº†ä¿®æ­£ï¼Œé‡æ–°æ¢³ç†äº†æ•´ä¸ªæ¡†æ¶

+ è°ƒæ•´äº†Deblurç½‘ç»œçš„å‚æ•°ï¼Œè®­ç»ƒäº†å‡ ä¸ªä¸åŒçš„æ¨¡å‹ï¼Œäº‰å–ä½¿deblurçš„æ•ˆæœæœ€å¥½

+ å­¦ä¹ imatestè½¯ä»¶çš„ä½¿ç”¨

------

### 2022.10.29ç»„ä¼š

+ è§†é¢‘3Dé™å™ªæ–¹æ³•å­¦ä¹ ï¼Œæ‹æ¸…æ€è·¯ï¼Œç”»å›¾ï¼Œæ•´ç†å¥½ä»£ç æ¡†æ¶

+ æ•°æ®ç±»å‹æ˜¯float32ï¼Œä¸èƒ½ç”¨uint8å¤„ç†ï¼Œä¼šä¸¢å¤±ä¿¡æ¯

+ ç»´çº³æ»¤æ³¢è¦åŠ TVçº¦æŸï¼Œæˆ–è€…å°è¯•ADMM+TV

#### æ ¹æ®ä»¥ä¸Šæ„è§å’Œæœ¬å‘¨çš„ç»“æœï¼Œç»§ç»­è°ƒæ•´debluréƒ¨åˆ†ï¼Œæé«˜å›¾åƒçš„æ•ˆæœ

------

### 2022.10.23-30 

### æ•´ä½“æ€è·¯ï¼Œç›®å‰çš„pipeline(å¢åŠ äº†ç¥ç»ç½‘ç»œå»æ¨¡ç³Š)

**ç›®æ ‡**ï¼šåŸºäºä¼ ç»Ÿçš„è§†é¢‘å»å™ªæ–¹æ³•ï¼Œå®ç°ä¸€ä¸ªåŠ¨æ€ä¸”å®æ—¶çš„è§†é¢‘å»å™ªè¿‡ç¨‹

**ä¼ ç»Ÿè§†é¢‘å®æ—¶é™å™ªæ–¹æ³•**ï¼šä½¿ç”¨å¿«é€Ÿçš„å¯¹é½ç®—æ³•ï¼Œæˆ–è€…ç”¨è¿åŠ¨æ£€æµ‹ä»£æ›¿è¿åŠ¨ä¼°è®¡ï¼Œæ ¹æ®æ£€æµ‹åˆ°çš„è¿åŠ¨å¼ºåº¦ï¼Œå¯¹æ—¶åŸŸæ»¤æ³¢å’Œç©ºåŸŸæ»¤æ³¢çš„ç»“æœåšåŠ æƒå¹³å‡ã€‚

**æˆ‘ä»¬çš„åŸºç¡€æ¡†æ¶**ï¼šåˆ©ç”¨HDR+æ–¹æ³•ä¸­çš„å¯¹é½ç®—æ³•ï¼Œé€šè¿‡é‡‘å­—å¡”æ–¹æ³•è®¡ç®—å¯¹é½ä½ç§»ï¼Œæ ¹æ®ä½ç§»å¾—å‡ºè¿åŠ¨å‘é‡ï¼Œå†æ ¹æ®è¿åŠ¨å‘é‡æ‰¾å‡ºç›¸ä¼¼å—ã€‚ç„¶åæ ¹æ®HDR+çš„åˆå¹¶æ–¹æ³•ï¼Œåˆ©ç”¨è¿™äº›åƒç´ å—å®ç°æ—¶åŸŸå’Œç©ºåŸŸä¸Šçš„é™å™ªã€‚

**å®ç°éš¾ç‚¹**ï¼š

   + å¯¹é½ï¼šä¼šå—åˆ°ç¯å¢ƒå…‰å˜åŒ–ï¼Œå™ªå£°ï¼Œè¿åŠ¨ç›®æ ‡ä»¥åŠé•¿æ›å…‰å¼•èµ·çš„æ¨¡ç³Šç­‰å½±å“ã€‚
  
   + èåˆï¼šéœ€è¦ä¸€ä¸ªç²¾å‡†çš„å™ªå£°å»ºæ¨¡æ–¹æ³•ä¼°è®¡å™ªå£°å¼ºåº¦åº”ç”¨åˆ°å¤šå¸§èåˆå»å™ªçš„è¿‡ç¨‹ä¸­ã€‚

**åˆæ­¥å®Œå–„çš„å…·ä½“æ–¹æ³•**ï¼š

   + å…ˆè¿›è¡Œå™ªå£°æ ‡å®šï¼Œæ ¹æ®ä¼°è®¡å‡ºçš„å™ªå£°å…ˆè¿›è¡Œé¢„å¤„ç†

   + åˆ©ç”¨bucketå®ç°ä¸€ä¸ªåŠ¨æ€çš„å¤„ç†è¿‡ç¨‹

   + åˆ©ç”¨è§†é¢‘å›¾åƒçš„å¸§é—´ä¿¡æ¯å»é™¤æ¨¡ç³Šï¼ˆä½¿ç”¨ESTRNN(ç¥ç»ç½‘ç»œ)å¯¹è§†é¢‘å›¾åƒå»æ¨¡ç³Šï¼‰

   + åŸºç¡€çš„é™å™ªæ–¹æ³•åŸºäºHDR+çš„å¤šå¸§èåˆè¿›è¡Œå»å™ª (é‡‘å­—å¡”å¯¹é½ï¼Œç„¶åæ ¹æ®å¯¹é½çš„ç»“æœè¿›è¡Œèåˆå»å™ª)

      + å¯¹é½ï¼šåˆ©ç”¨é‡‘å­—å¡”ç®—æ³•ï¼Œç”±ç²—åˆ°ç²¾è®¡ç®—å‡ºalignmentï¼Œæ ¹æ®alignmentä¼°è®¡å‡ºè¿åŠ¨å‘é‡ï¼Œæ‰¾åˆ°ç›¸ä¼¼çš„åƒç´ å—

      + åˆå¹¶ï¼šåˆ©ç”¨ç›¸ä¼¼çš„åƒç´ å—å’Œå™ªå£°æ–¹å·®åº”ç”¨åˆ°å¤šå¸§èåˆä¸­è¿›è¡Œæ—¶åŸŸå’Œç©ºåŸŸä¸Šçš„å»å™ªã€‚
     
   + ç›®å‰çš„æ¡†æ¶å›¾
   
   ![](../../Docs/Images/Pipeline1101.png)
   
+ æ ¹æ®ä»¥ä¸Špipelineå›¾(å™ªå£°å»ºæ¨¡å’Œé¢„å¤„ç†æœªåŠ å…¥)å¾—åˆ°çš„ç»“æœå¦‚ä¸‹(è¾“å…¥å·²æ›´æ”¹ï¼Œä¸æ˜¯int8),è¾“å…¥16å¸§ç”±äºæœ‰äº›å›¾åƒå¹¶æ²¡æœ‰ç»è¿‡å»æ¨¡ç³Šå¤„ç†çš„åˆ™èˆå¼ƒï¼Œåœ¨å¯¹é½å’Œåˆå¹¶é˜¶æ®µä½¿ç”¨çš„å¸§æ•°æ˜¯1ä¸ªå½“å‰å¸§å’Œ11ä¸ªå‚è€ƒå¸§ï¼Œå…±12å¸§

![](../../Docs/Images/20221030ç»“æœ/with_deblur/3.png)

+ starlightçš„ç®—æ³•ï¼Œæ— è¿åŠ¨æ¨¡ç³Šå¤„ç†çš„ç®—æ³•ï¼Œä¸Šè¿°pipelineç®—æ³•å¯¹æ¯”ç»“æœå¦‚ä¸‹

![](../../Docs/Images/20221030ç»“æœ/ä¸‰ä¸ªæ–¹æ³•å¯¹æ¯”ç»“æœ.png)

å…·ä½“ç»“æœè§(https://github.com/qilinsun/UltralLowLightRawVideoISP/tree/main/Docs/Images/20221030ç»“æœ)

------

### 2022.10.22ç»„ä¼š

#### ç»„ä¼šæ„è§æ€»ç»“
##### æ•´ä½“æ€è·¯æƒ³æ¸…æ¥šå¯ä»¥é‡æ–°ç”»ä¸€ä¸‹å›¾ï¼ŒæŒ‡å¯¼åç»­å·¥ä½œè¿›è¡Œ

+ ä¼ ç»Ÿçš„3Dæ–¹æ³•

+ å¢åŠ å›¾åƒçš„æ•°é‡ï¼Œå¯ä»¥é€‰å–H264ç”¨çš„16å¸§æˆ–19å¹´è®ºæ–‡ä¸­çš„13å¸§åš
+ + Commentï¼šä¹Ÿå¯ä»¥è¯•è¯•è¿™ä¸ª https://github.com/codeslake/PVDNet

+ ä½¿ç”¨æ·±åº¦å­¦ä¹ æ–¹æ³•ï¼ˆæ³¨æ„ä½¿ç”¨videoçš„æ—¶åºä¿¡æ¯ï¼‰

+ downsampleï¼šä¼°è®¡mvæ˜¯å¯ä»¥ï¼Œç›´æ¥å»æ¨¡ç³Šä¸éœ€è¦

+ åœ¨ä¼°è®¡ä¹‹å‰å…ˆåšä¸ªå›¾åƒé¢„å¤„ç†ï¼Œç®€å•çš„å»å™ªæ–¹æ³•å³å¯

+ **å…³äºoverlapï¼Œalignmentå’Œdublurä¸€èµ·åš** 
+ + Commentï¼šå¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ç¯‡æ–‡ç« ã€‚ä¸è¦æƒ³è±¡çš„å¤ªå¤æ‚äº†ï¼Œå°½å¯èƒ½æœ‰ä¸ªç®€å•æ¸…æ™°çš„pipelineï¼Œå¦‚æœæœ¬èº«è¿åŠ¨å¤ªå¤§ä¼°è®¡ä¸å‡†ï¼Œå¯ä»¥ç”¨é‡‘å­—å¡”çš„æ–¹å¼ï¼Œä»ç²—åˆ°ç²¾ï¼Œç„¶åæ‹¿ç²—ä¸€çº§çš„ç»“æœåšåˆå§‹åŒ–å†åˆ°ç²¾ä¸€çº§ã€‚
+ + https://ieeexplore.ieee.org/document/7025361 

+ äº†è§£2019ASIA çš„è¿åŠ¨ç®—æ³•

+ äº†è§£è§†é¢‘å»å™ªVBM4Dçš„æ€æƒ³

#### åç»­å·¥ä½œ

+ å»æ¨¡ç³Šå‰éœ€è¦ç®€å•çš„å»å™ªé¢„å¤„ç†

+ æ‰¾ä¼ ç»Ÿçš„3Dæ–¹æ³•ï¼Œå°è¯•å»æ¨¡ç³Š

+ å¢åŠ å›¾åƒçš„æ•°é‡ï¼Œä½¿ç”¨æ›´å¤šå¸§æ•°ä¼°è®¡è¿åŠ¨ï¼Œä»è€Œè¿›è¡Œå»æ¨¡ç³Š

+ ä½¿ç”¨æ·±åº¦å­¦ä¹ æ–¹æ³•

+ ä½¿ç”¨2019å¹´ASIAçš„æ–¹æ³•

+ Alignmentå’ŒDeblurä¸€èµ·åš

--------

### 2022.10.8-10.14 æ€»ç»“

+ åœ¨å…ˆå‰çš„piplineçš„åŸºç¡€ä¸Šï¼Œåœ¨mergeå‰ä½¿ç”¨ç»´çº³æ»¤æ³¢(+ TV) / fast deconvoltionï¼Œæ•ˆæœä¸æ˜æ˜¾

+ çœ‹äº†ç›¸å…³å™ªå£°æ ‡å®šçš„æ–¹æ³•ï¼šELDï¼Œæ–¹å·®å’Œå‡å€¼æ‹Ÿåˆçš„æ–¹æ³•

+ ä¿®æ”¹äº†piplineå›¾ï¼Œæ•´ç†ä»£ç æ¡†æ¶(å¾…ä¸Šä¼ )

![](../../Docs/Images/pipeline_221013.png)

+ å¯¼å…¥matlabé‡Œè¿åŠ¨ä¼°è®¡æ–¹æ³•ï¼Œå¾—åˆ°MVï¼š[code](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/Utility/matlab/motionEstDS.m)

### 2022.10.8-10.14 ä»£ç å’Œå¯¹åº”æµ‹è¯•ç»“æœ

+ ä½¿ç”¨H264æ–¹æ³•å’Œç»´çº³æ»¤æ³¢å¾—åˆ°çš„æœ€ç»ˆç»“æœ,gamma=0.5(æ— overlapçš„)

![](../../Docs/starlight/Motion_deblur/9_newpipeline_gamma0.5/0.jpg)

+ ä½¿ç”¨H264æ–¹æ³•å’Œç»´çº³æ»¤æ³¢çš„ç»“åˆ, gamma=0.15(overlapçš„)

![](../../Docs/starlight/Motion_deblur/9_deblur_overlap_gamma0.15/0.jpg)

------

### 2022.9.28â€”â€”2022.10.7

**Step 1**: ç›®å‰çš„ç®—æ³•å·²ç»ä¼°è®¡å‡ºäº†è¿åŠ¨å‘é‡ï¼Œæ ¹æ®å‘é‡è®¡ç®—é•¿åº¦å’Œè§’åº¦ï¼Œ

motionVector, (shapeï¼š[7, 63, 107, 2]) æ ¹æ®æ­¤ç®—å‡ºé•¿åº¦å’Œè§’åº¦ï¼Œlengthå’Œangleçš„shapeå‡ä¸º[7, 63, 107]

ä»£ç å¦‚ä¸‹ï¼š

```python
def motion_angle(motionvector):
  motionvector_y = motionvector[..., 0]
  motionvector_x = motionvector[..., 1]
  angle = np.arctan2(motionvector_y, motionvector_x)
  # angle = np.rad2deg(theta)
  
  return angle

def motion_vector_length(motionvector):
    n, h, w, _ = motionvector.shape
    length = np.zeros((n, h, w))
    angle = np.zeros((n, h, w))
    for i in range(len(motionvector)):
        if i == 0:
            mv = motionvector[i]
            mv_length = np.sqrt(mv[...,0]**2 + mv[...,1]**2)
            length[i, :, :] = mv_length
            mv_angle = motion_angle(mv)
            angle[i, :, :] = mv_angle
        else:
            cur_mv = motionvector[i]
            ref_mv = motionvector[i-1]
            diff_mv = cur_mv - ref_mv
            diff_mv_length = np.sqrt(diff_mv[...,0]**2 + diff_mv[...,1]**2)
            diff_mv_angle = motion_angle(diff_mv)
            length[i, :, :] = diff_mv_length
            angle[i, :, :] = diff_mv_angle

    return length, angle
```
**Step 2**: æ ¹æ®è®¡ç®—å‡ºçš„æ¯ä¸ªè§’åº¦å’Œé•¿åº¦å†ç”Ÿæˆæ¨¡ç³Šæ ¸

å¯è®¡ç®—å‡ºlengthå’Œangleçš„ç»„æˆ63*107å¯¹

[code](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/Utility/PSF.py)

```python
import numpy as np


def get_motion_blur(length, angle, aligntiles):
    # ç‚¹æ‰©æ•£å‡½æ•°
    n, h, w, size1, size2 = aligntiles.shape
    PSF_sum = np.zeros((aligntiles.shape[0] - 1, aligntiles.shape[1],
                        aligntiles.shape[2], aligntiles.shape[3], aligntiles.shape[4]))
    PSF_aver = np.zeros((int(h * size1), int(w * size2)))
    PSF_vis = np.zeros((n-1, int(h * size1/2+size1/2), int(w * size2/2+size1/2)))
    for i in range(aligntiles.shape[0] - 1):

        x_center = (aligntiles[i].shape[2] - 1) / 2
        y_center = (aligntiles[i].shape[3] - 1) / 2

        motion_length = length[i]
        motion_angle = angle[i]

        sin_val = np.sin(motion_angle)
        cos_val = np.cos(motion_angle)

        # è®¡ç®—æ¯ä¸ªtilesçš„psf å†reshape
        for j in range(motion_length.shape[0]):
            for n in range((motion_length.shape[1])):
                PSF = np.zeros((aligntiles.shape[3], aligntiles.shape[4]))
                if motion_length == 0:
                    # è¯¥å—å¤„çš„PSFç½®ä¸º0
                    PSF_sum[i, j, n, ...] = PSF
                else:
                    for m in range(int(np.round(motion_length[j][n]))):
                        x_offset = np.round(sin_val[j, n] * m)
                        y_offset = np.round(cos_val[j, n] * m)
                        x_1 = x_center - x_offset
                        y_1 = y_center + y_offset
                        if 0 <= x_1 < (aligntiles.shape[3]) and 0 <= y_1 < (aligntiles.shape[4]):
                            x = x_1
                            y = y_1
                        else:
                            x = x_center
                            y = y_center

                        PSF[int(x), int(y)] = 1

                    # è¿™éƒ¨åˆ†æœ‰äº›ç®—å‡ºå¾—0æ˜¯å› ä¸ºæ²¡æœ‰ä½ç§»ï¼Œlengthä¸º0ï¼Œæ‰€ä»¥åŠ äº†åˆ¤æ–­
                    PSF = PSF / PSF.sum()
                    PSF_sum[i, j, n, ...] = PSF

                    PSF_aver[(int(size1/2) * j):(int(size1/2) * j + size1),\
                    (int(size2/2)* n):(int(size2/2) * n + size2)] = PSF
        
        PSF_vis[i, ...] = PSF_aver
    # å¯è§†åŒ–   
    for v in range(PSF_vis.shape[0]):
        psf_path = "/home/cuhksz-aci-03/Documents/UltralLowLightRawVideoISP-main/psf_result/" + str(v) + '.png'
        cv2.imwrite(psf_path, PSF_vis[v])

    return PSF_sum
```
+ æ ¹æ®MVè®¡ç®—å‡ºçš„PSFç»“æœ(è¯¥ç»“æœä¹˜äº†255ä¹‹åçš„æ˜¾ç¤ºç»“æœ)

![PSFç»“æœ](../../Docs/starlight/PSF/PSF_221007/0.png) 

+ HDR+ MV 

![è¿åŠ¨çŸ¢é‡](../../Docs/starlight/align_mismatch/hdrplus_mv/vector_0.png)

**Step 3**: æ™®é€šç»´çº³æ»¤æ³¢

ä»£ç å¦‚ä¸‹ï¼š

```python
 # ç»´çº³æ»¤æ³¢ï¼ŒK=0.01
def wiener(input, PSF, eps, K=0.01):       
    input_fft = fft.fft2(input)
    PSF_fft = fft.fft2(PSF) + eps
    PSF_fft_1 = np.conj(PSF_fft) / (np.abs(PSF_fft) ** 2 + K)
    result = np.fft.ifft2(input_fft * PSF_fft_1)
    result = np.abs(np.fft.fftshift(result))
    return result
```
**æ™®é€šçš„ç»´çº³æ»¤æ³¢å¾—ä¸å‡ºç»“æœ**ï¼Œæ”¹ä¸ºdeep opticsä¸­çš„æ–¹æ³•ï¼Œ[code(tf-->pytorch)](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/Utility/wiener.py)

ä¸åŒgammaå€¼çš„ç»“æœ(éšä¾¿é€‰çš„), ä»¥ä¸‹è¿™äº›å›¾ç‰‡å’Œç›¸åº”çš„è§†é¢‘[Click](https://github.com/qilinsun/UltralLowLightRawVideoISP/tree/main/Docs/starlight)

+ code: åœ¨åŸä»£ç çš„HDR+ pipelinä¸­å¢åŠ äº†debluréƒ¨åˆ†

```python
# Hdrplus pipeline
        motionVectors, alignedTiles = alignHdrplus(referenceImg,alternateImgs,self.mbSize)
        
        # Deblur
        motion_length, motion_angle = motion_vector_length(motionVectors)
        PSF = get_motion_blur(motion_length, motion_angle, alignedTiles)

        deb_img = np.zeros(alignedTiles.shape)
        deb_img[-1, ...] = alignedTiles[-1, ...]
        for j in range(PSF.shape[0]):
            for m in range(PSF.shape[1]):
                for n in range(PSF.shape[2]):
                    blurred = repeat(alignedTiles[j, m, n, ...], 'h w -> b h w c', b=1, c=1) 
                    PSF_trans = repeat(PSF[j, m, n, ...], 'h w -> h w c d', c=1, d=1)
                    # transfer tensor
                    blurred = torch.tensor(blurred)
                    PSF_trans = torch.tensor(PSF_trans)
                    deblur_img = inverse_filter(blurred, blurred, PSF_trans, init_gamma=1.5)
                    deblur_img = deblur_img.squeeze()
                    deblur_img = deblur_img.detach().numpy()

                    deb_img[j, m, n, ...] = deblur_img

        alignedTiles = deb_img
        
        mergedImage = mergeHdrplus(referenceImg, alignedTiles, self.padding, 
                                   self.lambdaS, self.lambdaR, self.params, self.options)
        mergedImage = np.clip(mergedImage,0,self.whiteLevel)
        
        # ISP process
        ISP_output = starlightFastISP(mergedImage)
```

+ deblurä¹‹å‰çš„ç»“æœ_17Seq0

![deblurä¹‹å‰çš„ç»“æœ_17Seq0](../../Docs/starlight/ori_img/0.jpg)

+ gamma=0.5_17Seq0

![gamma=0.5_17Seq0](../../Docs/starlight/Motion_deblur/gamma0.5/0.jpg)

+ gamma=1.5_17Seq0

![gamma=1.5_17Seq0](../../Docs/starlight/Motion_deblur/gamma1.5/0.jpg)

+ gamma=5_17Seq0

![gamma=5_17Seq0](../../Docs/starlight/Motion_deblur/gamma5/0.jpg)


### ç›®å‰çš„é—®é¢˜

+ HDR+ çš„æ–¹æ³•åšè¿åŠ¨ä¼°è®¡å¯èƒ½ä¸è¡Œï¼Œéœ€è¦æ¢è¿åŠ¨ä¼°è®¡æ–¹æ³•, æ¢äº†ARPSæ–¹æ³•(è¿™éƒ¨åˆ†ä»£ç ä¹‹å‰çš„åŒå­¦å·²ç»è½¬æ¢å®Œï¼Œè‡ªå·±å¯¹ç…§C++æ£€æŸ¥å­¦ä¹ )ï¼Œ[code(C++-->Python)](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/Utility/utils.py)

### Todo

+ å°†ARPSæ”¾å…¥åˆ°Pipelineä¸­ï¼Œå¾—åˆ°MVï¼Œå†çœ‹motion deblurçš„æ•ˆæœ
