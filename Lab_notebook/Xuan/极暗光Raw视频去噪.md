

## ææš—å…‰Rawè§†é¢‘å»å™ª

### Final Goal

åœ¨ææš—å…‰ç¯å¢ƒä¸‹(lux: 0.1, 0.01å’Œ0.001)å®ç°å®æ—¶çš„å¯¹rawè§†é¢‘çš„å»å™ª

### Idea

å¤œæ™¯è§†é¢‘æ‹æ‘„ï¼šæ·±åº¦å­¦ä¹ ï¼ŒåŸºäºå¤šå¸§èåˆ

æ·±åº¦å­¦ä¹ ï¼šå¯è§£é‡Šæ€§å·®ï¼Œæ³›åŒ–æ€§èƒ½å·®

åŸºäºå¤šå¸§èåˆçš„æ–¹æ³•

FIFO

è¿åŠ¨æ¨¡ç³Š

é«˜å™ªå£°

------

### To do list 2023.5.29

- [x] å™ªå£°ä¼°è®¡
  + Imatest
  + å…¬å¼ï¼šğ’™_ğ’‘~ ğˆ_ğ’”^ğŸ ğ“Ÿ(ğ’š_ğ’‘/ğˆ_ğ’”^ğŸ) + ğ“Ÿ(ğ‘µ_ğ‘­ğ‘·ğ‘µ) + ğ“(ğŸ,ğˆ_ğ’“^ğŸ)

+ å›¾åƒæ•°æ®æ‹æ‘„

  - [x] 0.1 é™æ€å’ŒåŠ¨æ€Rawè§†é¢‘åºåˆ—

  - [x] 0.01 é™æ€å’ŒåŠ¨æ€Rawè§†é¢‘åºåˆ—

  - [ ] 0.001 é™æ€å’ŒåŠ¨æ€Rawè§†é¢‘åºåˆ—

- [x] FIFOç»“æ„ 

+ å•å¸§å›¾åƒå¤„ç†
  - [x] å¸§å†…å›¾åƒå»æ¨¡ç³Š
  - [x] ä½¿ç”¨BM3Dç¡¬é˜ˆå€¼æ–¹æ³•å…ˆå¯¹sensorçš„å™ªå£°è¿›è¡Œå»å™ª

- [ ] å¸§é—´åŒ¹é…
- [x] å°†åŒ¹é…å®Œçš„å›¾åƒè¿›è¡Œå †å ï¼Œä½¿ç”¨BM4Dæ–¹æ³•åœ¨è¿›è¡Œå»å™ª
- [ ] ISPè°ƒä¼˜

------

- [x] è¿åŠ¨æ¨¡ç³Šï¼Œåˆ©ç”¨å¸§é—´å…³ç³»ï¼ŒESTRNNæ–¹æ³• (è®­ç»ƒæ•°æ®æ˜¯é€šè¿‡rgbè½¬æ¢æˆrawå›¾åšçš„)
  + åˆ¶ä½œè®­ç»ƒæ•°æ®ï¼Œ[code](https://github.com/swz30/CycleISP)
  + ESTRNNï¼Œ[code](https://github.com/zzh-tech/ESTRNN)

------

### Pipeline 2023.5.29

<img src="../../Docs/Images/230529/Pipeline/0529_pipeline.png" alt=" " style="zoom:20%;" />

### æ ¹æ®Pipelineæ¯ä¸€æ­¥çš„å®éªŒç»“æœ

#### BM4D

+ è¯´æ˜

+ ä»£ç 

  + [bm4d](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/bm4d_pipeline/examples/run_bm4d_v3.py)

+ å‚æ•°çš„è®¾ç½®

  + è¾“å…¥ï¼š16å¼ åŸå§‹Rawå›¾åƒå †å çš„ä¸‰ç»´å›¾ï¼Œsize (h, w, 16)ï¼Œç¬¬ä¸€å¸§ä¸ºå½“å‰å¸§
  + å°†è¾“å…¥çš„æ•°æ®+3/8å¼€æ ¹å·
  + å™ªå£°ä¼°è®¡ï¼šåˆ©ç”¨çš„iccvçš„å™ªå£°ä¼°è®¡ç®—æ³•ï¼Œä¼°è®¡å †å çš„æ‰€æœ‰å›¾åƒçš„å™ªå£°æ–¹å·®
  + ç¡¬é˜ˆå€¼å˜æ¢ï¼šbior1.5ï¼Œå—ï¼š4 * 4 * 4ï¼Œæœç´¢æ­¥é•¿ï¼š3 * 3 * 3ï¼Œæœç´¢çª—å£ï¼š 7 * 7 * 7ï¼Œå—çš„ç›¸ä¼¼æ€§é˜ˆå€¼ï¼š200000ï¼Œæ•°é‡ï¼š16
  + ç»´çº³ååŒæ»¤æ³¢: dctï¼Œå—ï¼š4 * 4 * 4ï¼Œæœç´¢æ­¥é•¿ï¼š3 * 3 * 3ï¼Œæœç´¢çª—å£ï¼š 7 * 7 * 7ï¼Œå—çš„ç›¸ä¼¼æ€§é˜ˆå€¼ï¼š50000ï¼Œæ•°é‡ï¼š32
  + è¾“å‡ºï¼šè¾“å‡ºç»“æœï¼Œå›¾åƒå…ˆå¹³æ–¹-3/8åè¾“å‡º

  Ps: ä»¥ä¸Šè¿™äº›å‡åˆ†é€šé“è¿‡ä¸€é

+ å®éªŒç»“æœ

**0.1 é™æ€**

|                        Orignial image                        |                             BM4D                             |                             HDR+                             |                          Maskdngan                           |                            Hrnet                             |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![](../../Docs/Images/20230401/0.1_2500/still_2500_0.1/original.png) | ![](../../Docs/Images/20230401/0.1_2500/still_2500_0.1/BM4D.png) | ![](../../Docs/Images/20230401/0.1_2500/still_2500_0.1/hdr+.png) | ![](../../Docs/Images/20230401/0.1_2500/still_2500_0.1/maskdngan.png) | ![](../../Docs/Images/20230401/0.1_2500/still_2500_0.1/hrnet.png) |

**0.1 åŠ¨æ€**

|                        Orignial image                        |                             BM4D                             |                             HDR+                             |                          Maskdngan                           |                            Hrnet                             |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![](../../Docs/Images/20230401/0.1_2500/motion_2500_0.1/original.png) | ![](../../Docs/Images/20230401/0.1_2500/motion_2500_0.1/bm4d.png) | ![](../../Docs/Images/20230401/0.1_2500/motion_2500_0.1/hdr+.png) | ![](../../Docs/Images/20230401/0.1_2500/motion_2500_0.1/maskdngan.png) | ![](../../Docs/Images/20230401/0.1_2500/motion_2500_0.1/hrnet.png) |

**0. 01 é™æ€**

|                        Orignial image                        |                             BM4D                             |                             HDR+                             |                          Maskdngan                           |                            Hrnet                             |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![](../../Docs/Images/20230401/still_0.01_25600/original.png) | ![](../../Docs/Images/20230401/still_0.01_25600/bm4d.png) | ![](../../Docs/Images/20230401/still_0.01_25600/hdr+.png) | ![](../../Docs/Images/20230401/still_0.01_25600/maskdngan.png) | ![](../../Docs/Images/20230401/still_0.01_25600/hrnet.png) |

**0. 01 åŠ¨æ€**

|                        Orignial image                        |                             BM4D                             |                             HDR+                             |                          Maskdngan                           |                            Hrnet                             |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![](../../Docs/Images/20230401/motion_0.01_51200/original.png) | ![](../../Docs/Images/20230401/motion_0.01_51200/bm4d.png) | ![](../../Docs/Images/20230401/motion_0.01_51200/hdr+.png) | ![](../../Docs/Images/20230401/motion_0.01_51200/maskdngan.png) | ![](../../Docs/Images/20230401/motion_0.01_51200/hrnet.png) |

------

#### Pre-processing

+ è¯´æ˜

  + å°†é•œå¤´ç›–ä½ï¼Œè¿ç»­æ‹æ‘„å¤šå¸§å›¾åƒï¼Œç„¶åå¯¹è¿™ä¸€ç³»åˆ—å›¾åƒå¹³å‡ï¼Œä¼°è®¡ä¼ æ„Ÿå™¨å™ªå£°

  + ç„¶åå°†ä¼°è®¡çš„ä¼ æ„Ÿå™¨å™ªå£°å’Œææš—å…‰ä¸‹æ‹çš„å›¾åƒè¾“å…¥åˆ°bm3dç¡¬é˜ˆå€¼æ–¹æ³•ä¸­

  + åœ¨å¢åŠ äº†å—å‰”é™¤æ–¹æ³•åï¼Œåœ¨åŸæœ¬çš„bm3dç¡¬é˜ˆå€¼æ–¹æ³•ä¸­æ‰¾åˆ°ä¸€å®šæ•°é‡çš„å—åï¼ŒæŠŠä¸ç¬¦åˆè¦æ±‚çš„å—å»æ‰ï¼Œå…¶ä½™å—åšç¡¬é˜ˆå€¼æ»¤æ³¢å»å™ª

  + å—å»é™¤æ–¹æ³•

    + å…ˆå°†å›¾åƒè¿›è¡Œå‚…ç«‹å¶å˜æ¢ï¼Œå¹¶å°†ä½é¢‘åˆ†é‡ç§»åˆ°é¢‘åŸŸå›¾åƒçš„ä¸­å¿ƒä½ç½®

    + è·å–é«˜é¢‘ä¿¡æ¯ï¼š(1) ç”Ÿæˆäº†åœ†å½¢æ»¤æ³¢å™¨ï¼Œåœ†å†…å€¼ä¸º0ï¼Œå…¶ä½™éƒ¨åˆ†ä¸º1 (åŠå¾„ä¸º4)

      â€‹						   (2) åˆ©ç”¨åœ†å½¢æ»¤æ³¢å™¨å°†ç¬¬ä¸€æ­¥ä¸­é¢‘åŸŸå›¾çš„ä½é¢‘ä¿¡æ¯è¿‡æ»¤æ‰

    + å¾—åˆ°é«˜é¢‘åˆ†é‡åå¹¶åšäº†ä¸€ä¸ªå¹³å‡

    + ç„¶åå°†å…¶æ’åº (ç”±é«˜åˆ°ä½)ï¼Œè·å–å…¶ç´¢å¼•å€¼

    + ç„¶åæ ¹æ®ç´¢å¼•å€¼ï¼Œå–å‰å‡ ä½çš„å›¾åƒå’Œå¯¹åº”ä½ç½®åæ ‡

+ ä»£ç 

  + å™ªå£°ä¼°è®¡ï¼Œ[code1](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/bm4d_pipeline/examples/est_noise.py), [code2](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/bm4d_pipeline/examples/run_predenoise.py)
  + BM3Dç¡¬é˜ˆå€¼æ–¹æ³•å»é™¤sensorå™ªå£°, [code](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/bm4d_pipeline/examples/run_predenoise.py)
  + ç»Ÿè®¡å›¾åƒå—çš„ä½é¢‘å’Œé«˜é¢‘ä¿¡æ¯(ä½¿ç”¨ä½é€šæ»¤æ³¢å’Œé«˜é€šæ»¤æ³¢å®ç°)ï¼Œå°†ä½é¢‘ä¿¡æ¯å°‘çš„å›¾åƒå—æ‰”æ‰ï¼Œå…¶ä½™éƒ¨åˆ†è¿›è¡Œæ»¤æ³¢å»å™ª, [code](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/bm4d_pipeline/examples/bm3d_1st_step.py)

+ å‚æ•°çš„è®¾ç½®

  + å•ç‹¬BM3Dç¡¬é˜ˆå€¼é¢„å¤„ç†æ–¹æ³•
    + å—: 8 * 8, æœç´¢æ­¥é•¿: 3 * 3, å—æ•°: 16, æœç´¢åŒºåŸŸ: 19 * 19, ç›¸ä¼¼å—é˜ˆå€¼: 50000, ç¡¬é˜ˆå€¼å»å™ªçš„é˜ˆå€¼: è‡ªåŠ¨è°ƒæ•´

  + BM3Dç¡¬é˜ˆå€¼ç»“åˆå‰”é™¤å—å¤„ç†æ–¹æ³• (è®¾å®š20å—ï¼Œæ‰£é™¤4å—é«˜é¢‘åˆ†é‡å°‘çš„)
    + å—: 8 * 8, æœç´¢æ­¥é•¿: 3 * 3, å—æ•°: 16, æœç´¢åŒºåŸŸ: 19 * 19, ç›¸ä¼¼å—é˜ˆå€¼: 500000, ç¡¬é˜ˆå€¼å»å™ªçš„é˜ˆå€¼: 2.7

+ å®éªŒç»“æœ

  + bm3dé¢„å¤„ç†ç»“æœ

  **0.1 é™æ€**

  |                        Orignial image                        |                      Predenoising image                      |
  | :----------------------------------------------------------: | :----------------------------------------------------------: |
  | ![](../../Docs/Images/20230401/0.1_2500/still_2500_0.1/original.png) | ![](../../Docs/Images/230529/bm3dç¡¬é˜ˆå€¼æ–¹æ³•é¢„å¤„ç†ç»“æœ/predenoising_bm3d_hard/predenoise_0.1still_2500.png) |

  **0.1 åŠ¨æ€**

  |                        Orignial image                        |                      Predenoising image                      |
  | :----------------------------------------------------------: | :----------------------------------------------------------: |
  | ![](../../Docs/Images/20230401/0.1_2500/motion_2500_0.1/original.png) | ![](../../Docs/Images/230529/bm3dç¡¬é˜ˆå€¼æ–¹æ³•é¢„å¤„ç†ç»“æœ/predenoising_bm3d_hard/predenoise_0.1motion_2500.png) |

  **0.01 é™æ€**

  |                        Orignial image                        |                      Predenoising image                      |
  | :----------------------------------------------------------: | :----------------------------------------------------------: |
  | ![](../../Docs/Images/20230401/still_0.01_25600/original.png) | ![](../../Docs/Images/230529/bm3dç¡¬é˜ˆå€¼æ–¹æ³•é¢„å¤„ç†ç»“æœ/predenoising_bm3d_hard/predenoise_0.01still_25600.png) |

  **0.01 åŠ¨æ€**

  |                        Orignial image                        |                      Predenoising image                      |
  | :----------------------------------------------------------: | :----------------------------------------------------------: |
  | ![](../../Docs/Images/20230401/motion_0.01_51200/original.png) | ![](../../Docs/Images/230529/bm3dç¡¬é˜ˆå€¼æ–¹æ³•é¢„å¤„ç†ç»“æœ/predenoising_bm3d_hard/predenoise_0.01motion_51200.png) |

  + ä½¿ç”¨ç°åº¦å›¾åƒæµ‹è¯•æå–é«˜é¢‘ä½é¢‘éƒ¨åˆ†

  |                        Original image                        |                     High frequency image                     |                     Low frequency image                      |
  | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
  | ![](../../Docs/Images/230529/å—å»é™¤æ–¹æ³•æµ‹è¯•/å›¾åƒé¢‘ç‡ä¿¡æ¯/img_gray.png) | ![](../../Docs/Images/230529/å—å»é™¤æ–¹æ³•æµ‹è¯•/å›¾åƒé¢‘ç‡ä¿¡æ¯/high_freq_img.png) | ![](../../Docs/Images/230529/å—å»é™¤æ–¹æ³•æµ‹è¯•/å›¾åƒé¢‘ç‡ä¿¡æ¯/low_freq_img.png) |

  + ä½¿ç”¨æ¨¡ç³Šçš„ç°åº¦å›¾åƒè¿›è¡Œå—å‰”é™¤æµ‹è¯•

  |                         Sharp image                          |                          Blur image                          |                         Noisy image                          |                          BM3D_image                          |                        NewBM3D_image                         |
  | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
  | ![](../../Docs/Images/230529/å—å»é™¤æ–¹æ³•æµ‹è¯•/å»é™¤å—bm3d_hard/img_sharp.png) | ![](../../Docs/Images/230529/å—å»é™¤æ–¹æ³•æµ‹è¯•/å»é™¤å—bm3d_hard/blur_img.png) | ![](../../Docs/Images/230529/å—å»é™¤æ–¹æ³•æµ‹è¯•/å»é™¤å—bm3d_hard/noise_blur.png) | ![](../../Docs/Images/230529/å—å»é™¤æ–¹æ³•æµ‹è¯•/å»é™¤å—bm3d_hard/y_basic_blur_1.png) | ![](../../Docs/Images/230529/å—å»é™¤æ–¹æ³•æµ‹è¯•/å»é™¤å—bm3d_hard/y_basic_deblur.png) |

  + æ‹æ‘„å›¾åƒçš„å¯¹æ¯”ç»“æœ	

  **0.1 åŠ¨æ€**

  |                        Original image                        |                          BM3D Image                          |                       BM3D_Block Image                       |
  | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
  | ![](../../Docs/Images/20230401/0.1_2500/motion_2500_0.1/original.png) | ![](../../Docs/Images/230529/bm3dç¡¬é˜ˆå€¼æ–¹æ³•é¢„å¤„ç†ç»“æœ/predenoising_bm3d_hard/predenoise_0.1motion_2500.png) | ![](../../Docs/Images/230529/bm3dç¡¬é˜ˆå€¼æ–¹æ³•é¢„å¤„ç†ç»“æœ/predenoising_block/predenoisingv1_motion_0.1_2500.png) |

  **0.01 åŠ¨æ€**

  |                        Original image                        |                          BM3D Image                          |                       BM3D_Block Image                       |
  | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
  | ![](../../Docs/Images/20230401/motion_0.01_51200/original.png) | ![](../../Docs/Images/230529/bm3dç¡¬é˜ˆå€¼æ–¹æ³•é¢„å¤„ç†ç»“æœ/predenoising_bm3d_hard/predenoise_0.01motion_51200.png) | ![](../../Docs/Images/230529/bm3dç¡¬é˜ˆå€¼æ–¹æ³•é¢„å¤„ç†ç»“æœ/predenoising_block/predenoisingv1.png) |

------

#### ESTRNN 

+ æ–¹æ³•

<img src="../../Docs/Images/230529/Pipeline/ESTRNN.png" style="zoom: 50%;" />

+ æ•°æ®é›†

|                            RGB_GT                            |                            Raw_GT                            |                           RGB_Blur                           |                           Raw_Blur                           |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![](../../Docs/Images/230529/ESTRNNç»“æœ/RGB_GT.png) | ![](../../Docs/Images/230529/ESTRNNç»“æœ/Raw_GT.png) | ![](../../Docs/Images/230529/ESTRNNç»“æœ/RGB_Blur.png) | ![](../../Docs/Images/230529/ESTRNNç»“æœ/Raw_Blur.png) |

+ å®éªŒç»“æœ

|                              GT                              |                            Input                             |                            Output                            |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![](../../Docs/Images/230529/ESTRNNç»“æœ/Test_GT.png) | ![](../../Docs/Images/230529/ESTRNNç»“æœ/Test_raw_noise.png) | ![](../../Docs/Images/230529/ESTRNNç»“æœ/Test_output.png) |

------

#### Patch match

+ è¯´æ˜
![](../../Docs/Images/230529/Pipeline/Deepflow.png)
  + Deepflowéƒ¨åˆ†. 
    + å…ˆå°†Rawå›¾åƒè¿›è¡Œä¸‹é‡‡æ ·(å°†å››ä¸ªé€šé“RGGBè¿›è¡Œå¹³å‡)ï¼Œå¾—åˆ°ä¸€ç»„ä¸‹é‡‡æ ·å›¾åƒ
    + åˆ©ç”¨deepflowç®—æ³•(è°ƒç”¨çš„opencvé‡Œçš„deepflowå‡½æ•°)ï¼Œè®¡ç®—ç›¸é‚»å¸§(å‰ä¸€å¸§ä¸åä¸€å¸§ä¹‹é—´çš„å…‰æµå›¾)
    + ç„¶ååä¸€å¸§æ ¹æ®å…‰æµå›¾è¿›è¡Œwarpå¾—åˆ°å¯¹é½å›¾åƒ
  + è®¡ç®—ä¸­é—´å¸§ä½ç§»å¹¶è¿›è¡Œå›¾åƒå¯¹é½
    + åˆ©ç”¨deepflowæ–¹æ³•ï¼Œè®¡ç®—å‡ºç›¸é‚»å¸§çš„å…‰æµ
    + æ ¹æ®è®¡ç®—å‡ºçš„å¸§é—´å…‰æµè®¡ç®—å‡ºä½ç§»å‘é‡
    + è®¡ç®—ä¸­é—´å¸§ç›¸å¯¹äºç¬¬ä¸€å¸§çš„ä½ç§»å‘é‡ 
    + è®¡ç®—æ¯ä¸€å¸§ç›¸å¯¹äºä¸­é—´å¸§çš„ä½ç§»å‘é‡
    + å¯¹é½å›¾åƒ

+ ä»£ç 
  + [Deepflow](https://github.com/qilinsun/UltralLowLightRawVideoISP/blob/main/bm4d_pipeline/examples/test_raw.py)
+ å‚æ•°çš„è®¾ç½®
  + åŸåº“å‡½æ•°
+ å®éªŒç»“æœ

   **é™é‡‡æ ·çš„ç¬¬å››å¸§å’Œç¬¬äº”å¸§**

|                        Downsample # 3                        |                        Downsample # 4                        |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![](../../Docs/Images/230529/deepflow/downsample3.png) | ![](../../Docs/Images/230529/deepflow/downsample4.png) |

   **ç¬¬å››å¸§å’Œç¬¬äº”å¸§ä¹‹é—´çš„å…‰æµå›¾**

   ![](../../Docs/Images/230529/deepflow/flowmap34.png)

   **ç¬¬äº”å¸§å‘ç¬¬å››å¸§å¯¹é½çš„å›¾ç‰‡**

   ![](../../Docs/Images/230529/deepflow/align_img34.png)
------
